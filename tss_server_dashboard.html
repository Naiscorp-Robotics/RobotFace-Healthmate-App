<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSS Server Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2em;
        }
        .status-bar {
            background: #e8f5e8;
            padding: 10px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #4CAF50;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        .panel {
            background: #fafafa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #ddd;
        }
        .panel h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .log-area {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-danger {
            background: #dc3545;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .clients-list {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            min-height: 100px;
        }
        .client-item {
            background: white;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #28a745;
            font-family: monospace;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê TSS Server Dashboard</h1>
            <p>WebSocket Server Control Panel</p>
        </div>
        
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span id="serverStatus">Connecting to ws://localhost:12346...</span>
            </div>
            <div>
                <span id="clientCount">Connected Clients: 0</span>
                <button class="btn btn-secondary" onclick="connectToServer()" style="margin-left: 10px;">Reconnect</button>
            </div>
        </div>

        <div class="content">
            <div class="panel">
                <h3>üìä Server Statistics</h3>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalConnections">0</div>
                        <div class="stat-label">Total Connections</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="messagesSent">0</div>
                        <div class="stat-label">Messages Sent</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeClients">0</div>
                        <div class="stat-label">Active Clients</div>
                    </div>
                </div>

                <h3>üë• Connected Clients</h3>
                <div class="clients-list" id="clientsList">
                    <div style="color: #666; text-align: center; padding: 20px;">
                        No clients connected
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>üìù Server Logs</h3>
                <div class="log-area" id="serverLogs">
                    TSS WebSocket server started on ws://localhost:12346
                    Server will send structured JSON responses with step data, images, and audio
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="clearLogs()">Clear Logs</button>
                    <button class="btn btn-success" onclick="exportLogs()">Export Logs</button>
                    <button class="btn" onclick="getClientCount()">Refresh Client Count</button>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="panel">
                <h3>üì§ Send Step Data</h3>
                <div class="form-group">
                    <label for="stepNumber">Step Number:</label>
                    <input type="number" id="stepNumber" value="1" min="1" max="100">
                </div>
                
                <div class="form-group">
                    <label for="stepDescription">Step Description:</label>
                    <textarea id="stepDescription" placeholder="Enter step description...">Sample step description</textarea>
                </div>
                
                <div class="form-group">
                    <label for="imageData">Image Base64 (optional):</label>
                    <textarea id="imageData" placeholder="Enter base64 image data or leave empty for sample..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="audioData">Audio Base64 (optional):</label>
                    <textarea id="audioData" placeholder="Enter base64 audio data or leave empty for sample..."></textarea>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" onclick="sendStepData()">Send Step Data</button>
                    <button class="btn btn-secondary" onclick="loadSampleData()">Load Sample Data</button>
                    <button class="btn btn-danger" onclick="sendError()">Send Error</button>
                </div>
            </div>

            <div class="panel">
                <h3>‚ö° Quick Actions</h3>
                <div class="button-group">
                    <button class="btn" onclick="sendQuickStep(1, 'Initialize System')">Step 1: Initialize</button>
                    <button class="btn" onclick="sendQuickStep(2, 'Load Configuration')">Step 2: Config</button>
                    <button class="btn" onclick="sendQuickStep(3, 'Process Data')">Step 3: Process</button>
                    <button class="btn" onclick="sendQuickStep(4, 'Generate Report')">Step 4: Report</button>
                    <button class="btn" onclick="sendQuickStep(5, 'Cleanup')">Step 5: Cleanup</button>
                </div>
                
                <h3>üîÑ Auto Send</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="autoSend" onchange="toggleAutoSend()"> Enable Auto Send
                    </label>
                    <input type="number" id="autoSendInterval" value="5" min="1" max="60" style="width: 80px; margin-left: 10px;"> seconds
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" onclick="startAutoSend()">Start Auto Send</button>
                    <button class="btn btn-danger" onclick="stopAutoSend()">Stop Auto Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let connectedClients = new Set();
        let stats = {
            totalConnections: 0,
            messagesSent: 0,
            activeClients: 0
        };
        let autoSendInterval = null;
        let currentStep = 1;
        let serverWebSocket = null;

        // Sample data
        const sampleImageData = "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==";
        const sampleAudioData = "UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT";

        function log(message) {
            const logs = document.getElementById('serverLogs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        function updateStats() {
            document.getElementById('totalConnections').textContent = stats.totalConnections;
            document.getElementById('messagesSent').textContent = stats.messagesSent;
            document.getElementById('activeClients').textContent = stats.activeClients;
            document.getElementById('clientCount').textContent = `Connected Clients: ${stats.activeClients}`;
        }

        function updateClientsList() {
            const clientsList = document.getElementById('clientsList');
            if (connectedClients.size === 0) {
                clientsList.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No clients connected</div>';
            } else {
                clientsList.innerHTML = '';
                connectedClients.forEach(clientId => {
                    const clientItem = document.createElement('div');
                    clientItem.className = 'client-item';
                    clientItem.textContent = `Client ${clientId}`;
                    clientsList.appendChild(clientItem);
                });
            }
        }

        function sendStepData() {
            const stepNumber = parseInt(document.getElementById('stepNumber').value);
            const stepDescription = document.getElementById('stepDescription').value;
            const imageData = document.getElementById('imageData').value || sampleImageData;
            const audioData = document.getElementById('audioData').value || sampleAudioData;

            const stepData = {
                step_number: stepNumber,
                step_description: stepDescription,
                img_base64: imageData,
                audio_base64: audioData,
                timestamp: Date.now()
            };

            // Send command to server to broadcast to all clients
            const command = {
                type: "dashboard_command",
                command: "send_to_all_clients",
                step_data: stepData
            };

            // Send to the actual WebSocket server
            if (serverWebSocket && serverWebSocket.readyState === WebSocket.OPEN) {
                serverWebSocket.send(JSON.stringify(command));
                log(`Sent command to server to broadcast step data: ${JSON.stringify(stepData)}`);
                stats.messagesSent++;
                updateStats();
            } else {
                log('Error: Not connected to WebSocket server');
            }
        }

        function sendQuickStep(stepNumber, description) {
            document.getElementById('stepNumber').value = stepNumber;
            document.getElementById('stepDescription').value = description;
            sendStepData();
        }

        function sendError() {
            const errorData = {
                error: "Manual error triggered from dashboard",
                timestamp: Date.now()
            };
            
            // Send command to server to broadcast error to all clients
            const command = {
                type: "dashboard_command",
                command: "send_to_all_clients",
                step_data: errorData
            };
            
            if (serverWebSocket && serverWebSocket.readyState === WebSocket.OPEN) {
                serverWebSocket.send(JSON.stringify(command));
                log(`Sent error command to server: ${JSON.stringify(errorData)}`);
                stats.messagesSent++;
                updateStats();
            } else {
                log('Error: Not connected to WebSocket server');
            }
        }

        function loadSampleData() {
            document.getElementById('imageData').value = sampleImageData;
            document.getElementById('audioData').value = sampleAudioData;
            log('Loaded sample image and audio data');
        }

        function clearLogs() {
            document.getElementById('serverLogs').innerHTML = '';
        }

        function exportLogs() {
            const logs = document.getElementById('serverLogs').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tss-server-logs-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function toggleAutoSend() {
            const autoSend = document.getElementById('autoSend');
            if (autoSend.checked) {
                startAutoSend();
            } else {
                stopAutoSend();
            }
        }

        function startAutoSend() {
            if (autoSendInterval) {
                clearInterval(autoSendInterval);
            }
            
            const interval = parseInt(document.getElementById('autoSendInterval').value) * 1000;
            autoSendInterval = setInterval(() => {
                if (stats.activeClients > 0) {
                    sendQuickStep(currentStep, `Auto-generated step ${currentStep}`);
                    currentStep = (currentStep % 5) + 1;
                }
            }, interval);
            
            log(`Auto send started with ${interval/1000} second interval`);
        }

        function getClientCount() {
            if (serverWebSocket && serverWebSocket.readyState === WebSocket.OPEN) {
                const command = {
                    type: "dashboard_command",
                    command: "get_client_count"
                };
                serverWebSocket.send(JSON.stringify(command));
            }
        }

        function stopAutoSend() {
            if (autoSendInterval) {
                clearInterval(autoSendInterval);
                autoSendInterval = null;
                log('Auto send stopped');
            }
        }

        // Simulate client connections (for demo purposes)
        function simulateClientConnection() {
            const clientId = Math.floor(Math.random() * 1000);
            connectedClients.add(clientId);
            stats.totalConnections++;
            stats.activeClients = connectedClients.size;
            updateStats();
            updateClientsList();
            log(`Client ${clientId} connected`);
        }

        function simulateClientDisconnection() {
            if (connectedClients.size > 0) {
                const clientId = Array.from(connectedClients)[0];
                connectedClients.delete(clientId);
                stats.activeClients = connectedClients.size;
                updateStats();
                updateClientsList();
                log(`Client ${clientId} disconnected`);
            }
        }

        // Connect to WebSocket server
        function connectToServer() {
            try {
                serverWebSocket = new WebSocket('ws://localhost:12346');
                
                serverWebSocket.onopen = function(event) {
                    log('Connected to TSS WebSocket server');
                    document.getElementById('serverStatus').textContent = 'Connected to ws://localhost:12346';
                    document.querySelector('.status-dot').style.backgroundColor = '#4CAF50';
                    // Get initial client count
                    getClientCount();
                };
                
                serverWebSocket.onmessage = function(event) {
                    log(`Received from server: ${event.data}`);
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === "dashboard_response") {
                            if (data.status === "success") {
                                log(`‚úÖ ${data.message}`);
                            } else if (data.client_count !== undefined) {
                                log(`üìä Connected clients: ${data.client_count}`);
                                stats.activeClients = data.client_count;
                                updateStats();
                            }
                        } else if (data.step_number) {
                            log(`Server processed step ${data.step_number}: ${data.step_description}`);
                        }
                    } catch (e) {
                        log(`Received non-JSON message: ${event.data}`);
                    }
                };
                
                serverWebSocket.onclose = function(event) {
                    log('Disconnected from TSS WebSocket server');
                    document.getElementById('serverStatus').textContent = 'Disconnected from ws://localhost:12346';
                    document.querySelector('.status-dot').style.backgroundColor = '#f44336';
                };
                
                serverWebSocket.onerror = function(error) {
                    log('WebSocket error: ' + error);
                    document.getElementById('serverStatus').textContent = 'Connection error';
                    document.querySelector('.status-dot').style.backgroundColor = '#f44336';
                };
                
            } catch (error) {
                log('Failed to connect to WebSocket server: ' + error);
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            log('TSS Server Dashboard initialized');
            updateStats();
            
            // Connect to the WebSocket server
            connectToServer();
            
            // Simulate some client activity for demo
            setTimeout(simulateClientConnection, 2000);
            setTimeout(simulateClientConnection, 5000);
            setTimeout(simulateClientDisconnection, 8000);
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        sendStepData();
                        break;
                    case 'l':
                        e.preventDefault();
                        clearLogs();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportLogs();
                        break;
                }
            }
        });
    </script>
</body>
</html>
